using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;


using TRAVELMART.Common;
using TRAVELMART.BLL;
using System.Text;
using System.Drawing;
using System.Web.UI.HtmlControls;
using System.Web.Security;
using System.Xml;
using System.Globalization;


namespace TRAVELMART.Immigration
{
    public partial class CrewVerification : System.Web.UI.Page
    {


        /// <summary>
        /// Author: Muhallidin G Wali
        /// Date Created: 08/06/2013
        /// Description: pop up alert message
        /// </summary>
        /// <param name="s"></param>
        private void AlertMessage(string s)
        {
            s = s.Replace("'", "");
            s = s.Replace("\"", "");

            string sScript = "<script language='JavaScript'>";
            sScript += " var msg = ' " + s + " '; ";
            //sScript += "alert('" + s + "');";
            sScript += "alert( msg );";
            sScript += "</script>";
            ScriptManager.RegisterClientScriptBlock(this.Page, this.GetType(), "scr", sScript, false);
        }



        CultureInfo enCulture = new CultureInfo(TravelMartVariable.UserCultureInfo);

        protected void InitializeValues()
        {
            if (GlobalCode.Field2String(Session["UserName"]) == "")
            {
                Session["UserName"] = User.Identity.Name;
            }
            MembershipUser sUser = Membership.GetUser(GlobalCode.Field2String(Session["UserName"]));

            if (sUser == null)
            {
                Response.Redirect("~/Login.aspx");
            }
            else
            {
                if (!sUser.IsOnline)
                {
                    Response.Redirect("~/Login.aspx");
                }
            }
            Session["strPrevPage"] = Request.RawUrl;
           
        }

        protected void Page_Load(object sender, EventArgs e)
        {
             InitializeValues();
            string userName = GlobalCode.Field2String(Session["UserName"]);

            HiddenField uoHiddenFieldPopupCalendar = (HiddenField)Master.FindControl("uoHiddenFieldPopupCalendar");

            if (!IsPostBack)
            {
                ClearGridCrewVerification();
            }

            tblUCDate.Text = DateTime.Now.ToString("MM/dd/yyyy") + " [" + DateTime.Now.ToString("hh:mm tt") + "]";    
              
  
        }


        private void ClearGridCrewVerification()
        {
            try
            {

                txtTelephone.Text = "";  
               
                txtPassportNo.Text = "";  
                txtNationality.Text = "";  
                txtLastName.Text = ""; 
                txtFirstName.Text = ""; 
                txtLOEControlNo.Text = ""; 
                txtExpiration.Text = "";  
                txtDateOffBirth.Text = ""; 
                txtOtherComment.Text = "";  

                //txtPosition.Text = "";   
                //txtBrand.Text = "";  
                //txtJoindate.Text = ""; 
                //txtJoinShip.Text = ""; 
                //txtJoinPort.Text = ""; 
                //txtJoinCity.Text = "";  
                //txtPosition.Text = ""; 
                


                rdbFraudulentDoc.Checked = false; // immigration[0].IsFraudulentDoc);
                rdbOther.Checked =  false; // immigration[0].IsOther);
                rdbPriorConDep.Checked = false;// immigration[0].IsPriorConDep);
                rdbPriorIIssue.Checked = false; // immigration[0].IsPriorImmigIssues);
                chkNew.Checked = false; // immigration[0].NewHire);
                uoHDFCrewVericationID.Value = ""; // immigration[0].CrewVericationID.ToString();


                uoListviewAir.DataSource = null;
                uoListviewAir.DataBind();


                uoListViewHotelBook.DataSource = null;
                uoListViewHotelBook.DataBind();

                uoListViewTransportation.DataSource = null;
                uoListViewTransportation.DataBind();

                uoListViewCrewverification.DataSource = null;
                uoListViewCrewverification.DataBind();

                uoDataPagerCrewVerification.SetPageProperties(0, 1, false );

                uoListViewRecentEmployment.DataSource = null;
                uoListViewRecentEmployment.DataBind();


                tblUCDate.Text = DateTime.Now.ToString("MM/dd/yyyy") + " [" + DateTime.Now.ToString("hh:mm tt") + "]";
                Session["immigration"] = null;
            }
            catch (Exception ex)
            {
                throw ex; 
            }
            
        }

        protected void btnClear_click(object sender, EventArgs e)
        {
            ClearGridCrewVerification();
            txtUniqeID.Text = ""; 
        
        }

        protected string GetRequestColor()
        {

            var ColorCode = Eval("ColorCode");
            var ForCode = Eval("ForeColor");

            if (ColorCode.ToString() != "" && ForCode.ToString() != "")
            {
                ColorCode = ColorCode + "; color:" + ForCode + ";\"";

                //return ColorCode = ColorCode + ";" + "";
                return "<tr style=\" background-color:" + ColorCode + ">";
            }
            else if (ColorCode.ToString() != "" && ForCode.ToString() == "")
            {
                ColorCode = ColorCode + ";\" ";

                //return ColorCode = ColorCode + ";" + "";
                return "<tr style=\" background-color:" + ColorCode + ">";
            }
            else
            {
                //return "<tr style=\" background-color:" + ColorCode + ">";
                return "<tr>";
            }


        }
        protected void btnSearch_click(object sender, EventArgs e)
        {
            try
            {

                ImmigrationBLL BLL = new ImmigrationBLL();
                ClearGridCrewVerification();

                crewverification(BLL.CrewImmigration(0, GlobalCode.Field2Long(txtUniqeID.Text), 0, "", ""));

            }
            catch (Exception ex)
            { throw ex; }
        
        }

        void crewverification(List<CrewImmigration> immigration)
        {

            Session["immigration"] = immigration;

            if (immigration.Count == 0)
            {
                AlertMessage("Unique ID does not exist in the system </br> ");

                return; 
            }
           

             txtTelephone.Text = immigration[0].ContactNo;
            
             txtPassportNo.Text = immigration[0].PassportNo;
             txtNationality.Text = immigration[0].Nationality;
             txtLastName.Text = immigration[0].LastName;
             txtFirstName.Text = immigration[0].FirstName;
             txtLOEControlNo.Text = immigration[0].LOEControlNumber;
             txtExpiration.Text = immigration[0].PassportExpiredate;
             txtDateOffBirth.Text = immigration[0].DateOfBirth.ToString();
             txtOtherComment.Text = immigration[0].OtherDetail;

             //txtBrand.Text = immigration[0].Brand;
             //txtJoindate.Text = immigration[0].SignOnDate.ToString() ;
             //txtJoinShip.Text = immigration[0].Vessel;
             //txtJoinPort.Text = immigration[0].Seaport;
             //txtJoinCity.Text = immigration[0].Seaport;
             //txtPosition.Text = immigration[0].Rank;
             //txtPosition.Text =  immigration[0].Rank;

             uoListViewCrewverification.DataSource = immigration;
             uoListViewCrewverification.DataBind();
            

             rdbFraudulentDoc.Checked = GlobalCode.Field2Bool(immigration[0].IsFraudulentDoc);
             rdbOther.Checked = GlobalCode.Field2Bool(immigration[0].IsOther);
             rdbPriorConDep.Checked = GlobalCode.Field2Bool(immigration[0].IsPriorConDep);
             rdbPriorIIssue.Checked = GlobalCode.Field2Bool(immigration[0].IsPriorImmigIssues); 
             chkNew.Checked = GlobalCode.Field2Bool(  immigration[0].NewHire);
             uoHDFCrewVericationID.Value = immigration[0].CrewVericationID.ToString();

             //OpenPDF.HRef  = "../ReportViewer.aspx?report=Immigration&uID=" + txtUniqeID.Text; //document.getElementById("").value 
             if (immigration[0].CrewVericationID > 0)
             {
                 if (immigration[0].IsApproved == true)
                 {
                     tblUCDate.Text = DateTime.Now.ToString("MM/dd/yyyy") + " [" + DateTime.Now.ToString("hh:mm tt") + "]" + "       Assignment Status : Approved   ";
                 }
                 else
                 {
                     tblUCDate.Text = DateTime.Now.ToString("MM/dd/yyyy") + " [" + DateTime.Now.ToString("hh:mm tt") + "]" + "       Assignment Status : Declined   ";
                 }
             }
             else { 
                 tblUCDate.Text = DateTime.Now.ToString("MM/dd/yyyy") + " [" + DateTime.Now.ToString("hh:mm tt") + "]";
             }

             if (immigration[0].SeafarerImage.Count > 0)
             {
                 uoImageCM.ImageUrl = GlobalCode.Field2PictureImage(immigration[0].SeafarerImage[0].Image, immigration[0].SeafarerImage[0].ImageType);
             }

             if (immigration[0].ImmigrationAirTransaction.Count > 0)
             {
                 uoListviewAir.DataSource = immigration[0].ImmigrationAirTransaction;
                 uoListviewAir.DataBind();
             }
             else
             {
                 uoListviewAir.DataSource = null;
                 uoListviewAir.DataBind();
             }

             if (immigration[0].ImmigrationHotelBooking.Count > 0)
             {
                 uoListViewHotelBook.DataSource = immigration[0].ImmigrationHotelBooking;
                 uoListViewHotelBook.DataBind();
             }
             else
             {
                 uoListViewHotelBook.DataSource = null;
                 uoListViewHotelBook.DataBind();
             }

             if (immigration[0].ImmigrationTransportion.Count > 0)
             {
                 uoListViewTransportation.DataSource = immigration[0].ImmigrationTransportion;
                 uoListViewTransportation.DataBind();
             }
             else
             {
                 uoListViewTransportation.DataSource = null;
                 uoListViewTransportation.DataBind();
             }

             if (immigration[0].ImmigrationTransportion.Count > 0)
             {
                 uoListViewTransportation.DataSource = immigration[0].ImmigrationTransportion;
                 uoListViewTransportation.DataBind();
             }
             else
             {
                 uoListViewTransportation.DataSource = null;
                 uoListViewTransportation.DataBind();
             }


             if (immigration[0].ImmigrationEmploymentHistory.Count > 0)
             {
                 uoListViewRecentEmployment.DataSource = immigration[0].ImmigrationEmploymentHistory;
                 uoListViewRecentEmployment.DataBind();
             }
             else
             {
                 uoListViewRecentEmployment.DataSource = null;
                 uoListViewRecentEmployment.DataBind();
             }
 




        }


        protected void uoListViewCrewverification_PagePropertiesChanging(object sender, PagePropertiesChangingEventArgs e)
        {
            //set current page startindex, max rows and rebind to false
            uoDataPagerCrewVerification.SetPageProperties(e.StartRowIndex, e.MaximumRows, false);

            //rebind List View
            List<CrewImmigration> immigration = new List<CrewImmigration>();

            immigration = (List<CrewImmigration>)Session["immigration"];
            if (immigration != null )
            {
                crewverification(immigration, e.StartRowIndex);
            }
        }




        void crewverification(List<CrewImmigration> immigration, int RowInded)
        {

           
                tblUCDate.Text = DateTime.Now.ToString("MM/dd/yyyy") + " [" + DateTime.Now.ToString("hh:mm tt") + "]";

            if (immigration.Count > 0)
            {

                txtTelephone.Text = immigration[RowInded].ContactNo;

                txtPassportNo.Text = immigration[RowInded].PassportNo;
                txtNationality.Text = immigration[RowInded].Nationality;
                txtLastName.Text = immigration[RowInded].LastName;
                txtFirstName.Text = immigration[RowInded].FirstName;
                txtLOEControlNo.Text = immigration[RowInded].LOEControlNumber;
                txtExpiration.Text = immigration[RowInded].PassportExpiredate;
                txtDateOffBirth.Text = immigration[RowInded].DateOfBirth.ToString();
                txtOtherComment.Text = immigration[RowInded].OtherDetail;

                //txtBrand.Text = immigration[0].Brand;
                //txtJoindate.Text = immigration[0].SignOnDate.ToString() ;
                //txtJoinShip.Text = immigration[0].Vessel;
                //txtJoinPort.Text = immigration[0].Seaport;
                //txtJoinCity.Text = immigration[0].Seaport;
                //txtPosition.Text = immigration[0].Rank;
                //txtPosition.Text =  immigration[0].Rank;

                uoListViewCrewverification.DataSource = immigration;
                uoListViewCrewverification.DataBind();




                rdbFraudulentDoc.Checked = GlobalCode.Field2Bool(immigration[RowInded].IsFraudulentDoc);
                rdbOther.Checked = GlobalCode.Field2Bool(immigration[RowInded].IsOther);
                rdbPriorConDep.Checked = GlobalCode.Field2Bool(immigration[RowInded].IsPriorConDep);
                rdbPriorIIssue.Checked = GlobalCode.Field2Bool(immigration[RowInded].IsPriorImmigIssues);
                chkNew.Checked = GlobalCode.Field2Bool(immigration[RowInded].NewHire);
                uoHDFCrewVericationID.Value = immigration[RowInded].CrewVericationID.ToString();

                //OpenPDF.HRef  = "../ReportViewer.aspx?report=Immigration&uID=" + txtUniqeID.Text; //document.getElementById("").value 
                if (immigration[0].CrewVericationID > 0)
                {
                    if (immigration[0].IsApproved == true)
                    {
                        tblUCDate.Text = DateTime.Now.ToString("MM/dd/yyyy") + " [" + DateTime.Now.ToString("hh:mm tt") + "]" + "       Assignment Status : Approved   ";
                    }
                    else
                    {
                        tblUCDate.Text = DateTime.Now.ToString("MM/dd/yyyy") + " [" + DateTime.Now.ToString("hh:mm tt") + "]" + "       Assignment Status : Declined   ";
                    }
                }
                else
                {
                    tblUCDate.Text = DateTime.Now.ToString("MM/dd/yyyy") + " [" + DateTime.Now.ToString("hh:mm tt") + "]";
                }

                if (immigration[0].SeafarerImage.Count > 0)
                {
                    uoImageCM.ImageUrl = GlobalCode.Field2PictureImage(immigration[0].SeafarerImage[0].Image, immigration[0].SeafarerImage[0].ImageType);
                }

                if (immigration[0].ImmigrationAirTransaction.Count > 0)
                {
                    uoListviewAir.DataSource = immigration[0].ImmigrationAirTransaction;
                    uoListviewAir.DataBind();
                }
                else
                {
                    uoListviewAir.DataSource = null;
                    uoListviewAir.DataBind();
                }

                if (immigration[0].ImmigrationHotelBooking.Count > 0)
                {
                    uoListViewHotelBook.DataSource = immigration[0].ImmigrationHotelBooking;
                    uoListViewHotelBook.DataBind();
                }
                else
                {
                    uoListViewHotelBook.DataSource = null;
                    uoListViewHotelBook.DataBind();
                }

                if (immigration[0].ImmigrationTransportion.Count > 0)
                {
                    uoListViewTransportation.DataSource = immigration[0].ImmigrationTransportion;
                    uoListViewTransportation.DataBind();
                }
                else
                {
                    uoListViewTransportation.DataSource = null;
                    uoListViewTransportation.DataBind();
                }

                if (immigration[0].ImmigrationTransportion.Count > 0)
                {
                    uoListViewTransportation.DataSource = immigration[0].ImmigrationTransportion;
                    uoListViewTransportation.DataBind();
                }
                else
                {
                    uoListViewTransportation.DataSource = null;
                    uoListViewTransportation.DataBind();
                }


                if (immigration[0].ImmigrationEmploymentHistory.Count > 0)
                {
                    uoListViewRecentEmployment.DataSource = immigration[0].ImmigrationEmploymentHistory;
                    uoListViewRecentEmployment.DataBind();
                }
                else
                {
                    uoListViewRecentEmployment.DataSource = null;
                    uoListViewRecentEmployment.DataBind();
                }

            }
        }


        protected void btnApproved_click(object sender, EventArgs e)
        {
            try
            {
                ImmigrationBLL BLL = new ImmigrationBLL(); 
                 
                bool IsApproved = true;
                Button ApproveButton = (Button)sender;

                if (ApproveButton.ID == "btnApproved")
                    IsApproved = true;
                else
                    IsApproved = false;

                HiddenField uoCrewVericationID = null ;
                HiddenField uoLOEControlNumber = null;


                foreach (ListViewItem item in uoListViewCrewverification.Items)
                {
                    uoLOEControlNumber = (HiddenField)item.FindControl("uoHiddenFieldControlNo");
                    uoCrewVericationID = (HiddenField)item.FindControl("uoHiddenFieldCrewVericationID");
                }




                List<CrewImmigration> Immigration = new List<CrewImmigration>();


                Immigration.Add(new CrewImmigration
                {
                    CrewVericationID = GlobalCode.Field2Long(uoCrewVericationID.Value),
                    SeaparerID = GlobalCode.Field2Long(txtUniqeID.Text),
                    TravelReqID  = GlobalCode.Field2Long(uoHDFCrewVericationID.Value),
                    RecordLocator  = GlobalCode.Field2String(uoHDFRecordLocator.Value),
                    ItinerarySeqNo = GlobalCode.Field2Int(uoHDFItinerarySeqID.Value),
                    LOEControlNumber = GlobalCode.Field2String(txtLOEControlNo.Text ),
                    VesselID = GlobalCode.Field2Int(uoHDFVesselID.Value),
                    RankID = GlobalCode.Field2Int(uoHDFRankID.Value),



                    //Joindate = GlobalCode.Field2DateTime(txtJoindate.Text),
                    //JoinPort = GlobalCode.Field2String(txtJoinPort.Text ),
                    //JoinCity = GlobalCode.Field2String(txtJoinCity.Text),

                    Reason = 0, 
                    IsFraudulentDoc  = GlobalCode.Field2Bool(rdbFraudulentDoc.Checked  ),
                    IsPriorImmigIssues = GlobalCode.Field2Bool(rdbPriorIIssue.Checked),
                    IsPriorConDep = GlobalCode.Field2Bool(rdbPriorConDep.Checked),
                    IsOther = GlobalCode.Field2Bool(rdbOther.Checked),
                    IsApproved = GlobalCode.Field2Bool(IsApproved),
                    OtherDetail  = GlobalCode.Field2String(txtOtherComment.Text ),
                    UserID = GlobalCode.Field2String(uoHDFuserID.Value),

                });
                Immigration = BLL.InsertCrewImmigration(Immigration);

                int row = 0;

                foreach (CrewImmigration item in Immigration)
                {
                    if (item.CrewVericationID == GlobalCode.Field2Long(uoCrewVericationID.Value))
                    {
                        row = row + 1;
                    }
                }

                crewverification(Immigration, row);

            }
            catch (Exception ex)
            { throw ex; }
        }


    }
}
